{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="{% static 'game_field.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<nav class="navbar">
    <div class="logo">
        <img src="{% static 'image/LEGO_logo.svg.png' %}" alt="Bunker Logo">
        <span>BUNKER ONLINE</span>
    </div>
    <div class="menu">
        <a href="{% url 'index' %}">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="#rules">–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</a>
        <a href="#wiki">–í–∏–∫–∏</a>
        <a href="#updates">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</a>
    </div>
</nav>
<main>
    <div class="sidebar">
        <p>–ú–µ–Ω—é</p>
        <ul>
            <li><a href="#1">1</a></li>
            <li><a href="#2">2</a></li>
            <li><a href="#3">3</a></li>
            <li><a href="#4">4</a></li>
            <li><a href="#5">5</a></li>
            <li><a href="#6">6</a></li>
        </ul>
    </div>
    <div class="content">
        <h1>Game Start</h1>
        <h2>Player: {{ player.player_name }}</h2>
        <h2>Room: {{ room.name }}</h2>
        <h3>Bunker</h3>
        <p>–ë—ã–ª –ø–æ—Å—Ç—Ä–æ–µ–Ω {{ bunker.built_years_ago }} –ª–µ—Ç –Ω–∞–∑–∞–¥. {{ bunker.has_hygiene_facilities|yesno:"–ï—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –≥–∏–≥–∏–µ–Ω—ã,–ù–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤ –≥–∏–≥–∏–µ–Ω—ã" }}, {{ bunker.location_description }}, –≤—Å–µ —Å–ø–∞–ª—å–Ω–∏ –Ω–∞ {{ bunker.capacity }} —á–µ–ª–æ–≤–µ–∫</p>
        <p>–†–∞–∑–º–µ—Ä –±—É–Ω–∫–µ—Ä–∞: {{ bunker.size_sqm }} –∫–≤.–º</p>
        <p>–í—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è: {{ bunker.duration_of_stay_years }} –≥–æ–¥</p>
        <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥—ã: –Ω–∞ {{ bunker.food_supply_years }} –≥–æ–¥–∞</p>
        <p>–í –±—É–Ω–∫–µ—Ä–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç:</p>
        <ul>
            {% for feature in bunker.features.all %}
                <li>{{ feature.name }}</li>
            {% endfor %}
        </ul>
        <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –≤ –±—É–Ω–∫–µ—Ä–µ: {{ bunker.capacity }}</p>
        <h3>Cataclysm</h3>
        <p>{{ cataclysm.year }}: {{ cataclysm.description }}</p>
        <p>–í—Ä–µ–º—è –¥–æ –±—É–Ω–∫–µ—Ä–∞: {{ cataclysm.how_many_time_do_you_have }}</p>
        <p>–û—Å—Ç–∞–≤—à–µ–µ—Å—è –Ω–∞—Å–µ–ª–µ–Ω–∏–µ: {{ cataclysm.remaining_population }}</p>

        <h3>Player Information</h3>
        <table>
            <tr>
                <th>–ü–æ–ª</th>
                <td>{{ player.gender.name }}</td>
                <td><button class="{% if player.is_gender_open %}unlocked{% else %}locked{% endif %}" data-info="gender" data-value="{{ player.gender.name }}">{% if player.is_gender_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</th>
                <td>{{ player.body_build.name }}</td>
                <td><button class="{% if player.is_body_build_open %}unlocked{% else %}locked{% endif %}" data-info="body_build" data-value="{{ player.body_build.name }}">{% if player.is_body_build_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è —á–µ—Ä—Ç–∞</th>
                <td>{{ player.a_human_trait.name }}</td>
                <td><button class="{% if player.is_human_trait_open %}unlocked{% else %}locked{% endif %}" data-info="a_human_trait" data-value="{{ player.a_human_trait.name }}">{% if player.is_human_trait_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</th>
                <td>{{ player.speciality.name }}</td>
                <td><button class="{% if player.is_speciality_open %}unlocked{% else %}locked{% endif %}" data-info="speciality" data-value="{{ player.speciality.name }}">{% if player.is_speciality_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>–ó–¥–æ—Ä–æ–≤—å–µ</th>
                <td>{{ player.health.name }}</td>
                <td><button class="{% if player.is_health_open %}unlocked{% else %}locked{% endif %}" data-info="health" data-value="{{ player.health.name }}">{% if player.is_health_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>–•–æ–±–±–∏ / –£–≤–ª–µ—á–µ–Ω–∏–µ</th>
                <td>{{ player.hobby.name }}</td>
                <td><button class="{% if player.is_hobby_open %}unlocked{% else %}locked{% endif %}" data-info="hobby" data-value="{{ player.hobby.name }}">{% if player.is_hobby_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>–§–æ–±–∏—è / –°—Ç—Ä–∞—Ö</th>
                <td>{{ player.phobia.name }}</td>
                <td><button class="{% if player.is_phobia_open %}unlocked{% else %}locked{% endif %}" data-info="phobia" data-value="{{ player.phobia.name }}">{% if player.is_phobia_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</th>
                <td>{{ player.inventory.name }}</td>
                <td><button class="{% if player.is_inventory_open %}unlocked{% else %}locked{% endif %}" data-info="inventory" data-value="{{ player.inventory.name }}">{% if player.is_inventory_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è</th>
                <td>{{ player.more_information.name }}</td>
                <td><button class="{% if player.is_more_information_open %}unlocked{% else %}locked{% endif %}" data-info="more_information" data-value="{{ player.more_information.name }}">{% if player.is_more_information_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>Special Feature 1</th>
                <td>{{ player.special_feature1.name }}</td>
                <td><button onclick="toggleSpecialFeature('{{ player.id }}', 'special_feature1', '{{ player.is_special_feature1_open }}')" class="{% if player.is_special_feature1_open %}unlocked{% else %}locked{% endif %}" data-info="special_feature1" data-value="{{ player.special_feature1.name }}">{% if player.is_special_feature1_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
            <tr>
                <th>Special Feature 2</th>
                <td>{{ player.special_feature2.name }}</td>
                <td><button onclick="toggleSpecialFeature('{{ player.id }}', 'special_feature2', '{{ player.is_special_feature2_open }}')" class="{% if player.is_special_feature2_open %}unlocked{% else %}locked{% endif %}" data-info="special_feature2" data-value="{{ player.special_feature2.name }}">{% if player.is_special_feature2_open %}üîì{% else %}üîí{% endif %}</button></td>
            </tr>
        </table>
        <h3>–ñ–µ–ª–∞—é—â–∏–µ –ø–æ–ø–∞—Å—Ç—å –≤ –±—É–Ω–∫–µ—Ä ({{ room.players.count }}/{{ bunker.capacity }})</h3>
        <table>
            <thead>
            <tr>
                <th>–ò–º—è</th>
                <th>–ü–æ–ª</th>
                <th>–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</th>
                <th>–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è —á–µ—Ä—Ç–∞</th>
                <th>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</th>
                <th>–ó–¥–æ—Ä–æ–≤—å–µ</th>
                <th>–•–æ–±–±–∏ / –£–≤–ª–µ—á–µ–Ω–∏–µ</th>
                <th>–§–æ–±–∏—è / –°—Ç—Ä–∞—Ö</th>
                <th>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</th>
                <th>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è</th>
            </tr>
            </thead>
            <tbody id="players-info">
            {% for player in room.players.all %}
                <tr data-player="{{ player.player_name }}">
                    <td>{{ player.player_name }}</td>
                    <td class="{% if player.is_gender_open %}unlocked{% else %}locked{% endif %}" data-info="gender">{% if player.is_gender_open %}{{ player.gender.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_body_build_open %}unlocked{% else %}locked{% endif %}" data-info="body_build">{% if player.is_body_build_open %}{{ player.body_build.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_human_trait_open %}unlocked{% else %}locked{% endif %}" data-info="a_human_trait">{% if player.is_human_trait_open %}{{ player.a_human_trait.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_speciality_open %}unlocked{% else %}locked{% endif %}" data-info="speciality">{% if player.is_speciality_open %}{{ player.speciality.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_health_open %}unlocked{% else %}locked{% endif %}" data-info="health">{% if player.is_health_open %}{{ player.health.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_hobby_open %}unlocked{% else %}locked{% endif %}" data-info="hobby">{% if player.is_hobby_open %}{{ player.hobby.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_phobia_open %}unlocked{% else %}locked{% endif %}" data-info="phobia">{% if player.is_phobia_open %}{{ player.phobia.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_inventory_open %}unlocked{% else %}locked{% endif %}" data-info="inventory">{% if player.is_inventory_open %}{{ player.inventory.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_more_information_open %}unlocked{% else %}locked{% endif %}" data-info="more_information">{% if player.is_more_information_open %}{{ player.more_information.name }}{% else %} {% endif %}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <h3>–¢–∞–±–ª–∏—Ü–∞ —Å–ø–µ—Ü.–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π</h3>
        <table>
            <thead>
            <tr>
                <th>–ò–º—è</th>
                <th>–°–ø–µ—Ü.–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å ‚Ññ1</th>
                <th>–°–ø–µ—Ü.–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å ‚Ññ2</th>
            </tr>
            </thead>
            <tbody id="special-features-info">
            {% for player in room.players.all %}
                <tr data-player="{{ player.player_name }}">
                    <td>{{ forloop.counter }} | {{ player.player_name }}</td>
                    <td class="{% if player.is_special_feature1_open %}unlocked{% else %}locked{% endif %}" data-info="special_feature1">{% if player.is_special_feature1_open %}{{ player.special_feature1.name }}{% else %} {% endif %}</td>
                    <td class="{% if player.is_special_feature2_open %}unlocked{% else %}locked{% endif %}" data-info="special_feature2">{% if player.is_special_feature2_open %}{{ player.special_feature2.name }}{% else %} {% endif %}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        {% if is_creator %}
            <h3>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h3>
            <button id="start-voting-btn">–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</button>
            <button id="end-voting-btn" style="display: none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</button>
        {% endif %}

        <div id="voting-section" style="display: none;">
            <h3>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤ –∏–≥—Ä–æ–∫–∞</h3>
            <form id="voting-form">
                {% for game_player in room.players.all %}
                    {% if game_player.player_name != player.player_name %}
                    <div>
                        <input type="radio" id="vote_{{ game_player.id }}" name="vote" value="{{ game_player.player_name }}">
                        <label for="vote_{{ game_player.id }}">{{ game_player.player_name }}</label>
                    </div>
                    {% endif %}
                {% endfor %}
                <button type="submit">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>
            </form>
        </div>

        <div id="voting-results" style="display: none;">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</h3>
            <ul id="results-list"></ul>
        </div>
    </div>
</main>
<script>
    const roomName = "{{ room.name }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/game/${roomName}/`);

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        switch (data.message) {
            case 'update':
                handleUpdate(data);
                break;
            case 'start_voting':
                handleStartVoting();
                break;
            case 'vote':
                updateVotes(data.voter, data.vote);
                break;
            case 'end_voting':
                handleEndVoting();
                displayResults(data.votes);  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
                break;
        }
    };

    function displayResults(votes) {
        const resultsList = $('#results-list');
        resultsList.empty();
        for (const [player, voters] of Object.entries(votes)) {
            resultsList.append(`<li>${player}: ${voters.length} votes</li>`);
        }
        $('#voting-results').show();  // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —Ü–µ–π –±–ª–æ–∫ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è
    }


    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly:', e);

    };

function handleUpdate(data) {

    $(`#players-info tr[data-player="${data.player_name}"] td[data-info="${data.info_type}"]`).each(function() {
        $(this).removeClass('locked').addClass('unlocked').text(data.info_value);
    });

    // Specific handling for special features
    if (data.info_type === 'special_feature1' || data.info_type === 'special_feature2') {
        $(`#special-features-info tr[data-player="${data.player_name}"] td[data-info="${data.info_type}"]`).each(function() {
            $(this).removeClass('locked').addClass('unlocked').text(data.info_value);
        });
    }
}

    function handleStartVoting() {
        $('#voting-section').show();
        $('#start-voting-btn').hide();
        $('#end-voting-btn').show();
    }

    function handleEndVoting() {
        $('#voting-section').hide();
        $('#end-voting-btn').hide();
        $('#start-voting-btn').show();
        $('#voting-results').show();
    }

    function updateVotes(voter, vote) {
        const resultsList = $('#results-list');
        const existingEntry = resultsList.find(`li[data-voter="${voter}"]`);
        if (existingEntry.length) {
            existingEntry.text(`${voter}: voted for ${vote}`);
        } else {
            resultsList.append(`<li data-voter="${voter}">${voter}: voted for ${vote}</li>`);
        }
    }
    $(document).ready(function() {
        $('#voting-form').submit(function(e) {
            e.preventDefault();
            const vote = $('input[name="vote"]:checked').val();
            chatSocket.send(JSON.stringify({
                message: 'vote',
                vote: vote,
                voter: "{{ player.player_name }}"
            }));
        });

        $('#start-voting-btn').click(function() {
            chatSocket.send(JSON.stringify({ message: 'start_voting' }));
        });

        $('#end-voting-btn').click(function() {
            chatSocket.send(JSON.stringify({ message: 'end_voting' }));
        });

        $('.locked').click(function() {
            if ($(this).hasClass('unlocked')) {
                return;
            }
            $(this).removeClass('locked').addClass('unlocked').text('üîì');
            const infoType = $(this).data('info');
            const infoValue = $(this).data('value');
            const playerName = "{{ player.player_name }}";

            chatSocket.send(JSON.stringify({
                message: 'update',
                info_type: infoType,
                info_value: infoValue,
                player_name: playerName
            }));

            $.ajax({
                url: '{% url "update_player_info" %}',
                method: 'POST',
                data: {
                    player_name: playerName,
                    info_type: infoType,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('Player info updated successfully');
                },
                error: function(response) {
                    console.error('Error updating player info', response);
                }
            });
        });
    });
    
function toggleSpecialFeature(playerId, featureType, isFeatureOpen) {
    // Determine action based on current state
    const action = isFeatureOpen === 'true' ? 'lock' : 'unlock';

    fetch(`/activate_feature/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `player_id=${playerId}&feature_type=${featureType}&action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        location.reload(); // Reload the page to update the button state
    });
}
</script>


</body>
</html>